<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Life Manager (è¯Šæ–­ç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; --sub: #86868b;
            --primary: #007aff; --danger: #ff3b30; --warn: #ff9500;
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 10; }
        .app-title { font-weight: 700; font-size: 17px; }
        .status-badge { font-size: 12px; padding: 4px 10px; border-radius: 12px; background: #eee; color: #666; font-weight: 500; transition: 0.3s; cursor: pointer; }
        .status-badge.ok { background: #e4f9e6; color: #34c759; }
        .status-badge.err { background: #ffebeb; color: #ff3b30; }
        .status-badge.load { background: #eef7ff; color: #007aff; }

        /* æ ‡ç­¾æ  */
        .tabs { display: flex; gap: 10px; padding: 10px 16px; overflow-x: auto; flex-shrink: 0; background: var(--bg); }
        .tab { padding: 6px 14px; border-radius: 18px; font-size: 14px; color: var(--sub); white-space: nowrap; cursor: pointer; }
        .tab.active { background: #fff; color: var(--text); font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* ä¸»åŒºåŸŸ */
        .main { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }

        /* è¾“å…¥åŒº */
        .input-card { background: var(--card); padding: 16px; border-radius: 16px; box-shadow: var(--shadow); }
        .inp-tit { width: 100%; border: none; font-size: 16px; font-weight: 600; margin-bottom: 10px; outline: none; }
        .inp-note { width: 100%; border: none; border-bottom: 1px solid #eee; font-size: 13px; height: 30px; margin-bottom: 10px; outline: none; resize: none; color: #666; }
        .inp-tools { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
        .date-pick { background: #f2f2f7; border: none; border-radius: 8px; padding: 5px 8px; font-size: 12px; color: var(--primary); }
        .tag-row { display: flex; justify-content: space-between; align-items: center; }
        .chips { display: flex; gap: 8px; }
        .chip { padding: 4px 12px; border-radius: 12px; font-size: 12px; background: #f2f2f7; color: var(--sub); cursor: pointer; }
        .chip.active { background: #1d1d1f; color: #fff; }
        .btn-add { background: var(--primary); color: #fff; border: none; padding: 6px 16px; border-radius: 14px; font-weight: 600; cursor: pointer; }

        /* åˆ—è¡¨æ˜¾ç¤º */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-card { background: var(--card); padding: 12px; border-radius: 12px; display: flex; align-items: flex-start; gap: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .t-main { flex: 1; }
        .t-tit { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
        .t-meta { font-size: 12px; color: var(--sub); display: flex; gap: 8px; align-items: center; }
        .tag { padding: 2px 6px; border-radius: 4px; background: #f2f2f7; }
        .t-act { display: flex; flex-direction: column; gap: 8px; }
        .act-btn { border: none; background: transparent; color: #ccc; font-size: 16px; cursor: pointer; }
        .act-btn.done:hover { color: #34c759; }
        .act-btn.del:hover { color: #ff3b30; }

        /* å½’æ¡£æ ·å¼ */
        .archive-mode .task-card { opacity: 0.7; }
        .archive-mode .t-tit { color: #888; }
        
        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #fff; width: 80%; max-width: 300px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .m-tit { font-size: 16px; font-weight: 700; margin-bottom: 16px; text-align: center; }
        .m-inp { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; box-sizing: border-box; font-size: 14px; }
        .m-btn { width: 100%; padding: 10px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .m-close { text-align: center; margin-top: 10px; color: #999; font-size: 13px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="app-title">Life Manager</div>
    <div id="statusEl" class="status-badge" onclick="syncNow()">ç¦»çº¿æ¨¡å¼</div>
    <i class="fas fa-cog" onclick="openSet()" style="padding:10px; color:#666;"></i>
</header>

<div class="tabs">
    <div class="tab active" onclick="filter('all')" id="tab-all">å…¨éƒ¨</div>
    <div class="tab" onclick="filter('work')" id="tab-work">æŠ•èµ„</div>
    <div class="tab" onclick="filter('life')" id="tab-life">ç”Ÿæ´»</div>
    <div class="tab" onclick="filter('archive')" id="tab-archive">å½’æ¡£</div>
</div>

<div class="main">
    <!-- è¾“å…¥åŒº (éå½’æ¡£æ¨¡å¼æ˜¾ç¤º) -->
    <div class="input-card" id="inputArea">
        <input type="text" id="inTitle" class="inp-tit" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹...">
        <textarea id="inNote" class="inp-note" placeholder="å¤‡æ³¨..."></textarea>
        <div class="inp-tools">
            <input type="date" id="inDate" class="date-pick">
            <label style="font-size:13px; display:flex; align-items:center;"><input type="checkbox" id="inUrg"> ç´§æ€¥</label>
        </div>
        <div class="tag-row">
            <div class="chips">
                <div class="chip active" onclick="setCat('work')" id="chip-work">ğŸ’¼ æŠ•èµ„</div>
                <div class="chip" onclick="setCat('life')" id="chip-life">ğŸ  ç”Ÿæ´»</div>
                <div class="chip" onclick="setCat('health')" id="chip-health">â¤ï¸ å¥åº·</div>
            </div>
            <button class="btn-add" onclick="addItem()">æ·»åŠ </button>
        </div>
    </div>

    <div class="task-list" id="taskList"></div>
    <div style="text-align:center; color:#ccc; font-size:12px; margin-top:20px;" id="emptyMsg">æš‚æ— å†…å®¹</div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal" id="setModal">
    <div class="modal-box">
        <div class="m-tit">GitHub åŒæ­¥é…ç½®</div>
        <input class="m-inp" type="password" id="cfgToken" placeholder="Token (ghp_...)">
        <input class="m-inp" type="text" id="cfgUser" placeholder="ç”¨æˆ·å (User)">
        <input class="m-inp" type="text" id="cfgRepo" placeholder="ä»“åº“å (Repo)">
        <button class="m-btn" onclick="saveSet()">ä¿å­˜å¹¶è¿æ¥</button>
        <div class="m-close" onclick="closeSet()">å…³é—­</div>
        <div style="font-size:11px; color:red; margin-top:10px; line-height:1.4;">
            *æ³¨æ„ï¼šä»“åº“å¿…é¡»å·²å­˜åœ¨ï¼Œä¸”åŒ…å«README(éç©ºä»“åº“)ã€‚Tokenå¿…é¡»æœ‰repoæƒé™ã€‚
        </div>
    </div>
</div>

<script>
const DB_KEY = 'lm_db_v2';
let state = {
    tasks: JSON.parse(localStorage.getItem(DB_KEY) || '[]'),
    filter: 'all',
    cat: 'work',
    conf: {
        token: localStorage.getItem('gh_token') || '',
        user: localStorage.getItem('gh_user') || '',
        repo: localStorage.getItem('gh_repo') || ''
    },
    syncing: false
};

// --- åˆå§‹åŒ– ---
function init() {
    render();
    if(state.conf.token && state.conf.user && state.conf.repo) {
        setStatus('ready', 'ç‚¹å‡»åŒæ­¥');
        // è‡ªåŠ¨æ‹‰å–ä¸€æ¬¡
        syncNow();
    } else {
        setStatus('none', 'æœ¬åœ°æ¨¡å¼');
        if(state.tasks.length === 0) setTimeout(openSet, 500);
    }
}

// --- æ ¸å¿ƒåŒæ­¥é€»è¾‘ (è¯Šæ–­ç‰ˆ) ---
async function syncNow() {
    if(state.syncing) return;
    if(!state.conf.token) return alert("è¯·å…ˆé…ç½® GitHub Token");

    state.syncing = true;
    setStatus('load', 'æ­£åœ¨è¿æ¥ GitHub...');

    const { user, repo, token } = state.conf;
    const fileName = 'data.json';
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${fileName}`;

    try {
        // 1. å°è¯•è·å–è¿œç¨‹æ–‡ä»¶
        const getRes = await fetch(url + '?t=' + Date.now(), {
            headers: { 
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        let sha = null;
        let remoteTasks = [];

        if (getRes.status === 200) {
            // æ–‡ä»¶å­˜åœ¨ï¼šè¯»å–å¹¶åˆå¹¶
            const data = await getRes.json();
            sha = data.sha;
            try {
                const content = decodeURIComponent(escape(atob(data.content)));
                remoteTasks = JSON.parse(content);
            } catch(e) { console.error("Parse Error", e); }
        } else if (getRes.status === 404) {
            // æ–‡ä»¶ä¸å­˜åœ¨ï¼šè¿™å¾ˆæ­£å¸¸ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡
            console.log("äº‘ç«¯æ— æ–‡ä»¶ï¼Œå‡†å¤‡åˆ›å»º...");
        } else if (getRes.status === 401) {
            throw new Error("Token é”™è¯¯æˆ–è¿‡æœŸ (401)");
        } else if (getRes.status === 403) {
            throw new Error("æ— æƒé™ (403)ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦å‹¾é€‰äº† repo æƒé™");
        } else {
            // å¯èƒ½æ˜¯ä»“åº“ä¸å­˜åœ¨
            throw new Error(`è¿æ¥é”™è¯¯: ${getRes.status}ã€‚è¯·æ£€æŸ¥ç”¨æˆ·åæˆ–ä»“åº“åæ˜¯å¦æ­£ç¡®`);
        }

        // 2. åˆå¹¶æ•°æ® (ç®€å•çš„ ID å»é‡åˆå¹¶)
        const localMap = new Map(state.tasks.map(t => [t.id, t]));
        const remoteMap = new Map(remoteTasks.map(t => [t.id, t]));
        
        // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ä¿®æ”¹ï¼ŒåŒæ—¶å¸çº³äº‘ç«¯çš„æ–°æ•°æ®
        const merged = [...remoteTasks];
        state.tasks.forEach(localT => {
            const index = merged.findIndex(r => r.id === localT.id);
            if(index > -1) {
                merged[index] = localT; // è¦†ç›–äº‘ç«¯æ—§æ•°æ®
            } else {
                merged.push(localT); // æ–°å¢æœ¬åœ°æ•°æ®
            }
        });

        // æ›´æ–°æœ¬åœ°
        state.tasks = merged;
        saveLocal();

        // 3. ä¸Šä¼ å›äº‘ç«¯ (PUT)
        const putBody = {
            message: "Sync from LifeManager",
            content: btoa(unescape(encodeURIComponent(JSON.stringify(merged, null, 2))))
        };
        if (sha) putBody.sha = sha;

        const putRes = await fetch(url, {
            method: 'PUT',
            headers: { 
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(putBody)
        });

        if (!putRes.ok) {
            const errJson = await putRes.json();
            throw new Error(`ä¸Šä¼ å¤±è´¥ (${putRes.status}): ${errJson.message}`);
        }

        setStatus('ok', 'åŒæ­¥æˆåŠŸ');
        setTimeout(() => setStatus('ready', 'å‡†å¤‡å°±ç»ª'), 3000);

    } catch (err) {
        console.error(err);
        setStatus('err', 'åŒæ­¥å¤±è´¥');
        alert("åŒæ­¥å‡ºé”™åŸå› ï¼š\n" + err.message);
    } finally {
        state.syncing = false;
    }
}

// --- æœ¬åœ°é€»è¾‘ ---
function addItem() {
    const title = document.getElementById('inTitle').value.trim();
    if(!title) return alert("å†™ç‚¹ä»€ä¹ˆå§");
    
    state.tasks.push({
        id: Date.now(),
        title: title,
        note: document.getElementById('inNote').value,
        cat: state.cat,
        date: document.getElementById('inDate').value,
        urgent: document.getElementById('inUrg').checked,
        done: false,
        createAt: new Date().toISOString()
    });
    
    document.getElementById('inTitle').value = '';
    document.getElementById('inNote').value = '';
    saveLocal();
    syncNow(); // æ·»åŠ åè‡ªåŠ¨åŒæ­¥
}

function toggle(id) {
    const t = state.tasks.find(x => x.id === id);
    if(t) {
        t.done = !t.done;
        t.doneAt = t.done ? new Date().toISOString() : null;
        saveLocal();
        syncNow(); // ä¿®æ”¹åè‡ªåŠ¨åŒæ­¥
    }
}

function del(id) {
    if(confirm("åˆ é™¤è¿™æ¡ï¼Ÿ")) {
        state.tasks = state.tasks.filter(x => x.id !== id);
        saveLocal();
        syncNow();
    }
}

function clearArchive() {
    if(confirm("æ¸…ç©ºå½’æ¡£ï¼Ÿ")) {
        state.tasks = state.tasks.filter(t => !t.done);
        saveLocal();
        syncNow();
    }
}

// --- æ¸²æŸ“ ---
function render() {
    const list = document.getElementById('taskList');
    list.innerHTML = '';
    let count = 0;

    // æ’åºï¼šæœªå®Œæˆåœ¨å‰ï¼Œå®Œæˆåœ¨å
    const sorted = [...state.tasks].sort((a,b) => (a.done === b.done) ? 0 : a.done ? 1 : -1);

    sorted.forEach(t => {
        // è¿‡æ»¤é€»è¾‘
        if(state.filter === 'archive' && !t.done) return;
        if(state.filter !== 'archive' && t.done) return;
        if(state.filter !== 'all' && state.filter !== 'archive' && t.cat !== state.filter) return;

        count++;
        const dateStr = t.date ? `<span class="tag">${t.date.slice(5)}</span>` : '';
        const catMap = {work:'ğŸ’¼', life:'ğŸ ', health:'â¤ï¸'};
        const cls = t.done ? 'act-btn undo' : 'act-btn done';
        const icon = t.done ? 'fa-undo' : 'fa-check';
        
        let metaHtml = '';
        if(state.filter === 'archive') {
             metaHtml = `<div style="font-size:10px; color:#aaa; margin-top:4px;">
                åˆ›å»º: ${t.createAt?.slice(0,10) || '-'} / å®Œæˆ: ${t.doneAt?.slice(0,10) || '-'}
             </div>`;
        }

        const div = document.createElement('div');
        div.className = 'task-card';
        div.innerHTML = `
            <div class="t-main">
                <div class="t-tit" style="${t.done?'text-decoration:line-through;color:#aaa':''}">${t.title}</div>
                <div class="t-meta">
                    <span class="tag">${catMap[t.cat]||'â€¢'}</span>
                    ${dateStr}
                    ${t.urgent ? '<span class="tag" style="color:red">ğŸ”¥</span>' : ''}
                </div>
                ${t.note ? `<div style="font-size:12px;color:#999;margin-top:4px;">${t.note}</div>` : ''}
                ${metaHtml}
            </div>
            <div class="t-act">
                <button class="${cls}" onclick="toggle(${t.id})"><i class="fas ${icon}"></i></button>
                <button class="act-btn del" onclick="del(${t.id})"><i class="fas fa-trash"></i></button>
            </div>
        `;
        list.appendChild(div);
    });

    document.getElementById('emptyMsg').style.display = count ? 'none' : 'block';
    document.getElementById('inputArea').style.display = state.filter === 'archive' ? 'none' : 'block';
    
    // é«˜äº® Tab
    document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+state.filter).classList.add('active');
    
    // å½’æ¡£æ¨¡å¼
    document.body.className = state.filter === 'archive' ? 'archive-mode' : '';
}

// --- å·¥å…·å‡½æ•° ---
function saveLocal() {
    localStorage.setItem(DB_KEY, JSON.stringify(state.tasks));
    render();
}
function filter(f) { state.filter = f; render(); }
function setCat(c) { 
    state.cat = c; 
    document.querySelectorAll('.chip').forEach(e => e.classList.remove('active'));
    document.getElementById('chip-'+c).classList.add('active');
}
function setStatus(type, txt) {
    const el = document.getElementById('statusEl');
    el.className = 'status-badge ' + type;
    el.innerText = txt;
}

// è®¾ç½®ç•Œé¢
function openSet() {
    document.getElementById('cfgToken').value = state.conf.token;
    document.getElementById('cfgUser').value = state.conf.user;
    document.getElementById('cfgRepo').value = state.conf.repo;
    document.getElementById('setModal').style.display = 'flex';
}
function closeSet() { document.getElementById('setModal').style.display = 'none'; }
function saveSet() {
    state.conf.token = document.getElementById('cfgToken').value.trim();
    state.conf.user = document.getElementById('cfgUser').value.trim();
    state.conf.repo = document.getElementById('cfgRepo').value.trim();
    
    localStorage.setItem('gh_token', state.conf.token);
    localStorage.setItem('gh_user', state.conf.user);
    localStorage.setItem('gh_repo', state.conf.repo);
    
    closeSet();
    syncNow();
}

init();
</script>
</body>
</html>
